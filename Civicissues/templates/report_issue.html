<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Civic Issue</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    function initMap() {
      var map = L.map('map').setView([17.3850, 78.4867], 13); // default Hyderabad
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
      }).addTo(map);

      var marker;

      // Get user's current location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          map.setView([lat, lng], 15);
          marker = L.marker([lat, lng], {draggable: true}).addTo(map);
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;

          marker.on('dragend', function() {
            var pos = marker.getLatLng();
            document.getElementById('latitude').value = pos.lat;
            document.getElementById('longitude').value = pos.lng;
          });
        });
      }

      map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        if (!marker) {
          marker = L.marker([lat, lng], {draggable: true}).addTo(map);
          marker.on('dragend', function() {
            var pos = marker.getLatLng();
            document.getElementById('latitude').value = pos.lat;
            document.getElementById('longitude').value = pos.lng;
          });
        } else {
          marker.setLatLng([lat, lng]);
        }
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
      });
    }

    window.onload = initMap;
  </script>
</head>
<body class="bg-teal-50 text-teal-700 min-h-screen">
  <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}
</div>
  <div class="max-w-2xl mx-auto p-6 mt-10 bg-white rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold mb-6">Register a Civic Issue</h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="mb-4 text-green-700 font-semibold">
        {{ messages[0] }}
      </div>
    {% endif %}
    {% endwith %}

    <form action="{{ url_for('report_issue') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
      <input type="text" name="title" placeholder="Title" required class="w-full p-2 border rounded">
      <textarea name="description" placeholder="Description" rows="4" required class="w-full p-2 border rounded"></textarea>
      <input type="text" name="pincode" placeholder="Enter Pincode" required class="w-full p-2 border rounded">

      <!-- Map picker -->
      <label class="block font-semibold mt-2 mb-2">Pick Location on Map:</label>
      <div id="map" style="height: 300px;" class="mb-2 rounded border"></div>
      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">

      <select name="category" required class="w-full p-2 border rounded">
        <option value="">Select Category</option>
        <option value="Potholes">Potholes</option>
        <option value="Street Lights">Street Lights</option>
        <option value="Drainage">Drainage</option>
        <option value="Water Supply">Water Supply</option>
        <option value="Garbage / Waste">Garbage / Waste</option>
        <option value="Public Safety">Public Safety</option>
        <option value="Traffic Signals">Traffic Signals</option>
        <option value="Parks / Public Spaces">Parks / Public Spaces</option>
        <option value="Other">Other</option>
      </select>

      <select name="priority" required class="w-full p-2 border rounded">
        <option value="" disabled selected>Select Risk Level</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
      </select>

      <div>
        <label>Attach Photo (optional):</label>
        <input type="file" name="photo" class="w-full">
      </div>

      <div class="flex items-center space-x-2">
        <input type="checkbox" name="anonymous" value="yes" class="w-4 h-4">
        <label>Report anonymously</label>
      </div>

      <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded">Submit Issue</button>
    </form>
  </div>
<style>
    .flash-message {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
        font-weight: bold;
        color: white;
        opacity: 1;
        transition: opacity 0.5s ease-in-out;
    }
    .success { background-color: #4CAF50; }
    .error { background-color: #f44336; }
    .warning { background-color: #ff9800; }
    .hidden {
        opacity: 0;
        height: 0;
        padding: 0;
        margin: 0;
        border: none;
    }
</style>
</body>
</html>
